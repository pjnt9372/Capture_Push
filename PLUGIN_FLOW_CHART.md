# 本地插件运作流程图

```mermaid
graph TD
    A[应用程序启动] --> B[初始化SchoolPluginManager]
    B --> C[检查本地插件目录]
    C --> D{本地插件存在?}
    D -->|是| E[加载本地插件]
    D -->|否| F[尝试加载内置插件]
    E --> G[插件准备就绪]
    F --> G
    G --> H[用户选择功能]
    H --> I{选择更新检查}
    I -->|是| J[访问GitHub Release]
    I -->|否| K[选择学校代码]
    J --> L[获取plugins_index.json]
    L --> M[比较本地与远程版本]
    M --> N{远程版本更新?}
    N -->|是| O[提示用户更新]
    N -->|否| P[无更新]
    O --> Q[用户确认更新]
    Q --> R[下载插件ZIP]
    R --> S[验证SHA256校验和]
    S --> T{验证成功?}
    T -->|是| U[解压并安装插件]
    T -->|否| V[报告错误并保留原插件]
    U --> W[写入version.txt文件]
    W --> X[插件管理完成]
    V --> X
    P --> X
    K --> Y[插件管理器加载对应插件]
    Y --> Z[调用插件函数获取数据]
    Z --> AA[数据处理和显示]
    AA --> AB[插件使用完成]
    X --> AC[结束]
    AB --> AC
```

## 流程说明

1. **初始化阶段**：应用程序启动时初始化插件管理器，检查本地插件目录
2. **插件加载**：优先加载本地插件，如果不存在则加载内置插件
3. **更新检查**：用户可以选择检查插件更新，系统会从GitHub Release获取最新的插件索引
4. **插件安装**：如果发现新版本，系统会下载、验证并安装插件，同时写入version.txt文件
5. **插件使用**：用户选择学校代码后，系统加载对应插件并调用相应功能

## 版本管理

插件系统使用时间戳格式的版本号（YYYYMMDD_HHMMSS），存储在两个位置：
- `plugins_index.json` 中的 `plugin_version` 字段
- 插件ZIP包内的 `version.txt` 文件

本地版本检查通过读取插件目录下的 `version.txt` 文件进行比较。

## 插件管理UI操作

- **刷新插件列表**：清除缓存并从GitHub Release获取最新的 `plugins_index.json`，更新UI显示的插件列表
- **检查更新**：比较本地插件版本与远程版本，标识出哪些插件有可用更新
- **右键菜单**：
  - 已安装插件：提供"卸载插件"和"检查此插件更新"选项
  - 未安装插件：提供"安装插件"选项
- **版本显示**：当前版本列为"未安装"表示插件在JSON中存在但未安装