name: manual-sync

on:
  workflow_dispatch:
    inputs:
      note:
        description: 'å¤‡æ³¨'
        default: 'æ‰‹åŠ¨è§¦å‘åŒæ­¥'

jobs:
  sync-folder:
    runs-on: ubuntu-latest
    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºæºä»“åº“ä»£ç 
      - name: ğŸ›ï¸ æ£€å‡ºæºä»“åº“
        uses: actions/checkout@v4

      # ç¬¬äºŒæ­¥ï¼šæ£€å‡ºç›®æ ‡ä»“åº“
      - name: ğŸ—‚ï¸ æ£€å‡ºç›®æ ‡ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: pjnt9372/Capture_Push_Plugin
          ref: master
          path: target-repo
          token: $

      # ç¬¬ä¸‰æ­¥ï¼šæ ¸å¿ƒæ“ä½œ (å¤åˆ¶ + æ¨é€)
      - name: ğŸš€ æ‰§è¡ŒåŒæ­¥ä¸æ¨é€
        env:
          # å°† Token æš´éœ²ç»™è„šæœ¬ä½œä¸ºç¯å¢ƒå˜é‡
          ACCESS_TOKEN: $
        run: |
          # 1. æ£€æŸ¥æºæ–‡ä»¶å¤¹
          if [ ! -d "developer_space" ]; then
            echo "é”™è¯¯ï¼šæºä»“åº“ä¸­ä¸å­˜åœ¨ developer_space æ–‡ä»¶å¤¹"
            exit 1
          fi

          # 2. è¿›å…¥ç›®æ ‡ä»“åº“ç›®å½•
          cd target-repo || exit 1

          # 3. é…ç½® Git å®‰å…¨ç›®å½•ï¼ˆé˜²æ­¢æƒé™æŠ¥é”™ï¼‰
          git config --local --add safe.directory .

          # 4. è®¾ç½® Git ç”¨æˆ·ä¿¡æ¯ï¼ˆå¿…é¡»ï¼Œå¦åˆ™æäº¤å¤±è´¥ï¼‰
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"

          # 5. æ‹‰å–æœ€æ–°ä»£ç ï¼ˆé˜²æ­¢å†²çªï¼‰
          # --rebase ç¡®ä¿æœ¬åœ°ä¿®æ”¹åœ¨æœ€æ–°ä»£ç ä¹‹ä¸Š
          git pull --rebase origin master

          # 6. å›åˆ°å·¥ä½œåŒºï¼Œå¤åˆ¶æ–‡ä»¶ï¼ˆè¦†ç›–ç›®æ ‡æ–‡ä»¶å¤¹å†…å®¹ï¼‰
          # æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨ç»å¯¹è·¯å¾„æˆ–ç›¸å¯¹è·¯å¾„ç¡®ä¿å‡†ç¡®
          rm -rf developer_space/*
          cp -r ../developer_space/* developer_space/

          # 7. æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff-index --quiet HEAD --; then
            echo "â„¹ï¸ æ— éœ€æ›´æ–°ï¼šdeveloper_space æ–‡ä»¶å¤¹å†…å®¹æ²¡æœ‰å˜åŒ–ã€‚"
            exit 0
          fi

          # 8. æäº¤æ›´æ”¹
          git add .
          git commit -m "Update developer_space files"

          # 9. æ¨é€å›ç›®æ ‡ä»“åº“
          # ä½¿ç”¨ Token è¿›è¡Œ HTTPS æ¨é€
          git push https://$ACCESS_TOKEN@github.com/pjnt9372/Capture_Push_Plugin.git master
