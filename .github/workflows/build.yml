name: Build and Release

on:
  # ä»…å…è®¸æ‰‹åŠ¨è§¦å‘ï¼Œç¦ç”¨è‡ªåŠ¨æ„å»º
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'é€‰æ‹©è¦æ„å»ºæµ‹è¯•çš„åˆ†æ”¯'
        required: false
        default: 'current'
        type: choice
        options:
          - 'master'
          - 'Beta'
          - 'Dev'
      prerelease:
        description: 'æ˜¯å¦æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        default: false
        type: boolean

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
    env:
      PYTHONUTF8: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_branch == 'current' && github.ref || github.event.inputs.target_branch }}

      # =============== æ˜¾ç¤ºæ„å»ºä¿¡æ¯ ===============
      - name: Display Build Info
        shell: powershell
        run: |
          Write-Host "ğŸš€ æ„å»ºä¿¡æ¯"
          Write-Host "===================" 
          Write-Host "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          Write-Host "ç›®æ ‡åˆ†æ”¯: ${{ github.event.inputs.target_branch }}"
          Write-Host "å®é™…åˆ†æ”¯: ${{ github.ref_name }}"
          Write-Host "è¿è¡Œç¼–å·: ${{ github.run_number }}"
          Write-Host "===================" 
          
      # =============== ä¸¥æ ¼æ ¡éªŒ VERSION æ ¼å¼ ===============
      - name: Validate VERSION format
        shell: powershell
        run: |
          $versionLine = Get-Content "VERSION" -TotalCount 1 -ErrorAction SilentlyContinue
          if (-not $versionLine) {
            Write-Error "âŒ VERSION file is missing or empty!"
            exit 1
          }
          $version = $versionLine.Trim()
          if ($version -eq "") {
            Write-Error "âŒ VERSION file is empty!"
            exit 1
          }

          Write-Host "VERSION content: '$version'"

          $stablePattern = '^\d+\.\d+\.\d+$'
          $betaPattern   = '^\d+\.\d+\.\d+_Beta$'
          $devPattern    = '^\d+\.\d+\.\d+_Dev$'

          $isMasterPush = "${{ github.ref }}" -eq "refs/heads/master"
          $isBetaPush = "${{ github.ref }}" -eq "refs/heads/Beta"

          if ($isMasterPush) {
            # master åˆ†æ”¯å¿…é¡»æ˜¯ç¨³å®šç‰ˆ
            if ($version -notmatch $stablePattern) {
              Write-Error "âŒ On 'master', VERSION must be 'x.x.x' (e.g., '1.2.3'). Found: '$version'"
              exit 1
            }
          } elseif ($isBetaPush) {
            # Beta åˆ†æ”¯å¿…é¡»å¸¦æœ‰ _Beta åç¼€
            if ($version -notmatch $betaPattern) {
              Write-Error "âŒ On 'Beta' branch, VERSION must be 'x.x.x_Beta'. Found: '$version'"
              exit 1
            }
          } else {
            # æ‰‹åŠ¨è§¦å‘ï¼šå…è®¸ä¸‰ç§æ ¼å¼
            if (-not ($version -match $stablePattern -or $version -match $betaPattern -or $version -match $devPattern)) {
              Write-Error "âŒ VERSION must be 'x.x.x', 'x.x.x_Beta', or 'x.x.x_Dev'. Found: '$version'"
              exit 1
            }
          }

      # =============== æ„å»ºæ­¥éª¤ ===============
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip

      - name: Configure CMake for Tray App
        run: |
          cmake -S tray -B tray/build -DCMAKE_BUILD_TYPE=Release

      - name: Build Tray App
        run: |
          cmake --build tray/build --config Release

      - name: Create Portable Python Environment
        shell: powershell
        run: |
          $pyVersion = "3.11.9"
          $pyUrl = "https://www.python.org/ftp/python/$pyVersion/python-$pyVersion-embed-amd64.zip"
          Invoke-WebRequest -Uri $pyUrl -OutFile "python_embed.zip"
          Expand-Archive -Path "python_embed.zip" -DestinationPath ".venv"
          
          cd .venv
          $pthFile = Get-ChildItem -Filter "python*._pth" | Select-Object -First 1
          $content = Get-Content $pthFile.Name
          $content = $content -replace '#import site', 'import site'
          $content | Set-Content $pthFile.Name
          
          Invoke-WebRequest -Uri "https://bootstrap.pypa.io/get-pip.py" -OutFile "get-pip.py"
          .\python.exe get-pip.py --no-warn-script-location
          .\python.exe -m pip install -r ..\requirements.txt --no-warn-script-location
          
          Remove-Item "get-pip.py", "..\python_embed.zip"
          cd ..
          Write-Host "âœ… Portable Python ready."

      - name: Setup Inno Setup Chinese Support
        shell: powershell
        run: |
          if (-not (Test-Path "ChineseSimplified.isl")) {
            $url = "https://raw.githubusercontent.com/kira-96/Inno-Setup-Chinese-Simplified-Translation/master/ChineseSimplified.isl"
            Invoke-WebRequest -Uri $url -OutFile "ChineseSimplified.isl"
          }
          if ((Get-Content "ChineseSimplified.isl" -Raw) -notmatch "\[LangOptions\]") {
            throw "Invalid ChineseSimplified.isl"
          }

      - name: Build Full Installer
        shell: powershell
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" Capture_Push_Setup.iss

      - name: Build Lite Installer
        shell: powershell
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" Capture_Push_Lite_Setup.iss

      # =============== ç”Ÿæˆæ ¡éªŒå’Œæ–‡ä»¶ ===============
      - name: Generate Checksums
        shell: powershell
        run: |
          $fullInstaller = "Output/Capture_Push_Setup.exe"
          $liteInstaller = "Output/Capture_Push_Lite_Setup.exe"
          
          if (Test-Path $fullInstaller) {
            $fullHash = (Get-FileHash -Path $fullInstaller -Algorithm SHA256).Hash
            "$fullHash  $(Split-Path $fullInstaller -Leaf)" | Out-File -FilePath "Capture_Push_Setup.exe.sha256" -Encoding ASCII
            Write-Host "Full installer SHA256: $fullHash"
            echo "FULL_INSTALLER_SHA256=$fullHash" >> $env:GITHUB_ENV
          }
          
          if (Test-Path $liteInstaller) {
            $liteHash = (Get-FileHash -Path $liteInstaller -Algorithm SHA256).Hash
            "$liteHash  $(Split-Path $liteInstaller -Leaf)" | Out-File -FilePath "Capture_Push_Lite_Setup.exe.sha256" -Encoding ASCII
            Write-Host "Lite installer SHA256: $liteHash"
            echo "LITE_INSTALLER_SHA256=$liteHash" >> $env:GITHUB_ENV
          }

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Installers-${{ github.run_number }}
          path: |
            Output/Capture_Push_Setup.exe
            Output/Capture_Push_Lite_Setup.exe
            *.sha256
          retention-days: 3

      # =============== æå–ç‰ˆæœ¬å¹¶å‡†å¤‡å‘å¸ƒ ===============
      - name: Extract Version
        shell: powershell
        run: |
          $version = (Get-Content "VERSION" | Select-Object -First 1).Trim()
          Add-Content -Path $env:GITHUB_ENV -Value "APP_VERSION=$version"
          $tagVersion = "v$version" -replace "_", "-"
          Add-Content -Path $env:GITHUB_ENV -Value "TAG_VERSION=$tagVersion"

      # =============== æ¡ä»¶æ€§å‘å¸ƒ Release ===============
      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: ${{ !contains(env.APP_VERSION, '_Dev') && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/Beta' || github.event_name == 'workflow_dispatch') }}
        with:
          files: |
            Output/Capture_Push_Setup.exe
            Output/Capture_Push_Lite_Setup.exe
          tag_name: ${{ env.TAG_VERSION }}
          name: Release ${{ env.APP_VERSION }}
          body: |
            Version: ${{ env.APP_VERSION }}
            Build: ${{ github.run_number }}
            Target Branch: ${{ github.event.inputs.target_branch }}
            Actual Branch: ${{ github.ref_name }}
            Trigger: ${{ github.event_name }}
            
            ## Packages
            - **Full**: Includes Python runtime (~200-500 MB)
            - **Lite**: Program-only update (~2-10 MB)
            
            ## Integrity Checks
            - **Full SHA256**: `${{ env.FULL_INSTALLER_SHA256 }}`
            - **Lite SHA256**: `${{ env.LITE_INSTALLER_SHA256 }}`
            
            You can verify the integrity of the downloaded files using these hashes.
            Please do not use versions older than 0.4.0
          draft: false
          # å¦‚æœæ˜¯ Beta åˆ†æ”¯ï¼Œæˆ–è€…ç‰ˆæœ¬å·åŒ…å« _Betaï¼Œæˆ–è€…æ‰‹åŠ¨å‹¾é€‰äº† prereleaseï¼Œåˆ™æ ‡è®°ä¸ºé¢„å‘å¸ƒ
          prerelease: ${{ github.ref == 'refs/heads/Beta' || contains(env.APP_VERSION, '_Beta') || github.event.inputs.prerelease == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}